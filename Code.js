// Name: Runtime Options
// ID: runtimeoptions
// Description: Get and modify turbo mode, framerate, interpolation, clone limit, stage size, and more.
// License: MIT AND MPL-2.0

/* generated l10n code */Scratch.translate.setup({"ca":{"_Runtime Options":"Opcions d'execució"},"cs":{"_Runtime Options":"Nastavení běhu"},"de":{"_Runtime Options":"Laufzeit-Optionen"},"es":{"_Runtime Options":"Opciones de Runtime"},"fi":{"_Infinity":"ääretön","_Runtime Options":"Ajonaikaiset asetukset","_[thing] enabled?":"onko [thing] käytössä?","_clone limit":"klooniraja","_default ({n})":"oletus ({n})","_disabled":"pois päältä","_enabled":"päällä","_framerate":"kuvataajuus","_framerate limit":"kuvataajuus","_height":"korkeus","_high quality pen":"korkealaatuinen kynä","_interpolation":"interpolaatio","_remove fencing":"aitauksen poistaminen","_remove misc limits":"erilaisten rajoitusten poistaminen","_run green flag [flag]":"klikkaa vihreää lippua [flag]","_set [thing] to [enabled]":"kytke [thing] [enabled]","_set clone limit to [limit]":"aseta kloonirajaksi [limit]","_set framerate limit to [fps]":"aseta kuvataajuudeksi [fps]","_set stage size width: [width] height: [height]":"aseta esiintymislavan leveydeksi [width] ja korkeudeksi [height]","_set username to [username]":"aseta käyttäjänimeksi [username]","_stage [dimension]":"esiintymislavan [dimension]","_stage size":"esiintymislavan koko","_turbo mode":"turbotila","_username":"käyttäjänimi","_when [WHAT] changed":"kun [WHAT] muuttuu","_width":"leveys"},"fr":{"_Runtime Options":"Options d'exécution"},"hu":{"_Runtime Options":"Lefutási Opciók"},"it":{"_Infinity":"infinito","_Runtime Options":"Opzioni Esecuzione","_[thing] enabled?":"[thing] abilitato","_clone limit":"limite cloni","_default ({n})":"predefinito({n})","_disabled":"sblocca","_enabled":"blocca","_framerate":"frequenza","_framerate limit":"limite framerate","_height":"altezza","_high quality pen":"penna alta qualità","_interpolation":"interpolazione","_remove fencing":"rimuovi i limiti dallo Stage","_remove misc limits":"rimuovi limiti","_run green flag [flag]":"esegui tutti i cappelli bandiera verde [flag]","_set [thing] to [enabled]":"imposta [thing] a [enabled]","_set clone limit to [limit]":"imposta limite cloni a [limit]","_set framerate limit to [fps]":"imposta limite framerate a [fps]","_set stage size width: [width] height: [height]":"imposta dimensioni Stage larghezza: [width]altezza: [height]","_set username to [username]":"imposta username a [username]","_stage [dimension]":"[dimension] dello Stage","_stage size":"dimensioni Stage","_turbo mode":"modalità turbo","_width":"larghezza"},"ja":{"_Infinity":"無限","_Runtime Options":"ランタイムのオプション","_[thing] enabled?":"[thing]が有効","_clone limit":"クローンの制限","_default ({n})":"デフォルト({n})","_disabled":"無効","_enabled":"有効","_framerate":"フレームレート","_framerate limit":"フレームレートの制限","_height":"高さ","_high quality pen":"ペンできれいに描画する","_interpolation":"補完機能","_run green flag [flag]":"緑の旗[flag]を実行する","_set [thing] to [enabled]":"[thing]を[enabled]にする","_set clone limit to [limit]":"クローンの制限を[limit]にする","_set framerate limit to [fps]":"フレームレートの制限を[fps]にする","_set stage size width: [width] height: [height]":"ステージの横幅を[width]高さを[height]にする","_set username to [username]":"ユーザー名を[username]にする","_stage [dimension]":"ステージの[dimension]","_turbo mode":"ターボモード","_username":"ユーザー名","_width":"横幅"},"ja-hira":{"_Runtime Options":"ランタイムのオプション"},"ko":{"_Infinity":"무제한","_Runtime Options":"실행 설정","_[thing] enabled?":"[thing]이(가) 활성화 되었는가?","_clone limit":"복제본 개수 제한","_default ({n})":"기본 ({n})","_disabled":"비활성화","_enabled":"활성화","_framerate":"프레임률","_framerate limit":"프레임률 제한","_height":"높이","_high quality pen":"고품질 펜","_interpolation":"보간법","_remove fencing":"무대 밖 동작","_remove misc limits":"기타 제한 비활성화","_run green flag [flag]":"[flag] 시작하기","_set [thing] to [enabled]":"[thing]을(를) [enabled]하기","_set clone limit to [limit]":"복제본 개수 제한을 [limit](으)로 정하기","_set framerate limit to [fps]":"프레임률 제한을 [fps](으)로 정하기","_set stage size width: [width] height: [height]":"무대 크기를 넓이:[width] 높이:[height] (으)로 정하기","_set username to [username]":"사용자 이름을 [username](으)로 정하기","_stage [dimension]":"무대 [dimension]","_stage size":"무대 크기","_turbo mode":"터보 모드","_username":"사용자 이름","_when [WHAT] changed":"[WHAT]이(가) 변경되었을 때","_width":"넓이"},"lt":{"_Runtime Options":"Paleidimo laiko parinktys"},"nb":{"_Infinity":"Uendelighet","_Runtime Options":"Kjøretidsalternativer","_[thing] enabled?":"[thing] aktivert?","_clone limit":"klon grense","_default ({n})":"standard ({n})","_disabled":"deaktivert","_enabled":"aktivert","_framerate":"Bildetakt","_framerate limit":"grense for bildefrekvens","_height":"høyde","_high quality pen":"Høy kvalitet penn","_interpolation":"interpolasjon","_remove fencing":"Fjern gjerde","_remove misc limits":"fjern diverse begrensninger","_run green flag [flag]":"kjør grønt flagg [flag]","_set [thing] to [enabled]":"sett [thing] til [enabled]","_set clone limit to [limit]":"sett klon-grensen til [limit]","_set framerate limit to [fps]":"begrens bildefrekvensen til [fps]","_set stage size width: [width] height: [height]":"sett scenestørrelse bredde: [width] høyde: [height]","_set username to [username]":"sett brukernavn til [username]","_stage [dimension]":"scene [dimension]","_stage size":"scenestørrelse","_turbo mode":"turbo modus","_username":"brukernavn","_when [WHAT] changed":"når [WHAT] endret seg","_width":"bredde"},"nl":{"_Infinity":"oneindig","_Runtime Options":"Looptijdopties","_[thing] enabled?":"[thing] ingeschakeld?","_clone limit":"kloonlimiet","_default ({n})":"standaard ({n})","_disabled":"uit","_enabled":"in","_framerate limit":"framerate-limiet","_height":"hoogte","_high quality pen":"pen met hoge kwaliteit","_interpolation":"interpolatie","_remove fencing":"waarde-limieten weghalen","_remove misc limits":"diverse limieten weghalen","_run green flag [flag]":"voer groene vlag [flag] uit","_set [thing] to [enabled]":"schakel [thing] [enabled]","_set clone limit to [limit]":"maak kloonlimiet [limit]","_set framerate limit to [fps]":"maak framerate-limiet [fps]","_set stage size width: [width] height: [height]":"maak speelveldbreedte: [width] en -hoogte: [height]","_set username to [username]":"maak gebruikersnaam [username]","_stage [dimension]":"[dimension] van speelveld","_stage size":"speelveldgrootte","_turbo mode":"turbomodus","_username":"gebruikersnaam","_when [WHAT] changed":"wanneer [WHAT] verandert","_width":"breedte"},"pl":{"_Runtime Options":"Opcje Uruchamiania","_height":"wysokość","_set clone limit to [limit]":"ustaw limit klonów na [limit]","_turbo mode":"tryb turbo","_username":"nazwa użytkownika","_width":"szerokość"},"pt":{"_Runtime Options":"Opções de Execução"},"pt-br":{"_Runtime Options":"Opções de Execução"},"ru":{"_Infinity":"Бесконечно","_Runtime Options":"Опции Выполнения","_[thing] enabled?":"[thing] включен?","_clone limit":"лимит клонов","_default ({n})":"по умолчанию ({n})","_disabled":"выключен","_enabled":"включен","_framerate":"частота кадров","_framerate limit":"лимит частоты кадров","_height":"высота","_high quality pen":"перо в высоком качестве","_interpolation":"интерполяция","_remove fencing":"убрать рамку","_remove misc limits":"убрать разные ограничения","_run green flag [flag]":"запустить зеленый флажок [flag]","_set [thing] to [enabled]":"задать [thing] в [enabled]","_set clone limit to [limit]":"задать лимит клонов в [limit]","_set framerate limit to [fps]":"задать лимит частоты кадров в [fps]","_set stage size width: [width] height: [height]":"задать ширину: [width] высоту: [height] сцены","_set username to [username]":"задать имя пользователя как [username]","_stage [dimension]":"[dimension] сцены","_stage size":"размер сцены","_turbo mode":"турбо режим","_username":"имя пользователя","_when [WHAT] changed":"когда [WHAT] изменён","_width":"ширина"},"sl":{"_Runtime Options":"Možnosti izvajanja"},"sv":{"_Runtime Options":"Körtidsalternativ"},"tr":{"_Runtime Options":"Çalışma Zamanı Seçenekleri"},"uk":{"_Infinity":"без меж","_Runtime Options":"Параметри виконання","_[thing] enabled?":"[thing] увімкнено?","_clone limit":"макс. кількість клонів","_default ({n})":"за умовчанням ({n})","_disabled":"вимкнути","_enabled":"увімкнути","_framerate":"частота кадрів","_framerate limit":"макс. частота кадрів","_height":"висота","_high quality pen":"перо високої якості","_interpolation":"інтерполяція","_remove fencing":"прибрати рамку","_remove misc limits":"прибрати різні обмеження","_run green flag [flag]":"натиснути на [flag]","_set [thing] to [enabled]":"[enabled] налаштування [thing]","_set clone limit to [limit]":"встановити макс. кількість клонів до [limit]","_set framerate limit to [fps]":"встановити макс. частоту кадрів [fps]","_set stage size width: [width] height: [height]":"встановити розмір сцени: ширина: [width] висота: [height]","_set username to [username]":"встановити ім'я користувача [username]","_stage [dimension]":"[dimension] сцени","_stage size":"розмір сцени","_turbo mode":"режим турбо","_username":"ім'я користувача","_when [WHAT] changed":"коли [WHAT] змінено","_width":"ширина"},"zh-cn":{"_Infinity":"无限","_Runtime Options":"运行选项","_[thing] enabled?":"启用了[thing]？","_clone limit":"克隆限制","_default ({n})":"默认值({n})","_disabled":"禁用","_enabled":"启用","_framerate":"帧率","_framerate limit":"FPS上限","_height":"高度","_high quality pen":"高清画笔","_interpolation":"补帧","_remove fencing":"允许角色移出舞台","_remove misc limits":"取消音效范围与画笔大小限制","_run green flag [flag]":"运行绿旗[flag]","_set [thing] to [enabled]":"设置[thing]为[enabled]","_set clone limit to [limit]":"设置克隆体限制为[limit]","_set framerate limit to [fps]":"设置FPS上限为[fps]","_set stage size width: [width] height: [height]":"把舞台大小设置为宽[width] 高[height]","_set username to [username]":"设置用户名称为[username]","_stage [dimension]":"舞台的[dimension]","_stage size":"舞台尺寸","_turbo mode":"加速模式","_username":"用户名称","_when [WHAT] changed":"当[WHAT]被修改时","_width":"宽度"},"zh-tw":{"_Runtime Options":"運行選項"}});/* end generated l10n code */(function (Scratch) {
  "use strict";

  if (!Scratch.extensions.unsandboxed) {
    throw new Error("Runtime Options extension needs to be run unsandboxed");
  }

  const greenFlagURI =
    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAABFFBMVEUAAACAgABVqlVJkklAn0BNmTNLljxGlzpDmzdFmjpGmzxHmz9Fmj1FmT5Emj1GmT1GmD1EmDxGmTxEmT1GmjxGmT1FmDxEmT5EmTxGmT5FmD1GmT5FmT1Gmj1EmT5FmT1FmT1FmDxGmT1FmjxLs09LtE9Jr0xJsk1Js05JtVBKtU5KtVBKtlBJrkpJsE1KtlFIrEpIsExLt1FLuFJKuVNIqkhLulNIp0VJqkhKtlJLvVRMvFNFmT5GpUVFmT1HpEVHokNMvlVFmT1Ho0NFmTxLvlVGoUFMvlVLvlVGn0BFmT1Nv1ZEmz5FmTxFmTxFmT1NvlZFmz9FmT5FnT9FnD5GnT9Mv1ZMv1ZMv1ZFmT1Mv1b////70P2GAAAAWXRSTlMAAgMHCAoRFhcwMz0/RkdQVGFmaWpxcnh7gIGEhZKZo6eprLq/v8DAwMDAwMDBwcHCwsPDxcbIysrLzM3Pz9DQ1NTV1dfZ29vg4uXm5+jp6ens7fDx9Pv8/nPb5aAAAAABYktHRFt0vJU0AAAAsUlEQVQoz2NgwA3YhNiwS4hHykoou9goCrKiSUhGhqhZe7gbm3rxQwQ4BJihEupRYODooMDFyMAu6uMsgyoRFW5kHxjkqeuhL4cmAQM4JXRwSWjjktDEJaGFS0IVIeFtZuIaAZdQgUmY2/oqyTu5WcEkNGAS/kJMQJrbySAAJBxmGSoIlYAoYGCR8rPVM7QItuNlQJVgYGDlE5MU5kSErhz2+KCihEikNHYJJh5mBhIAADBcR/r5OJzCAAAAAElFTkSuQmCC";
  const TURBO_MODE = "turbo mode";
  const INTERPOLATION = "interpolation";
  const REMOVE_FENCING = "remove fencing";
  const REMOVE_MISC_LIMITS = "remove misc limits";
  const HIGH_QUALITY_PEN = "high quality pen";
  const FRAMERATE = "framerate";
  const CLONE_LIMIT = "clone limit";
  const STAGE_SIZE = "stage size";
  const USERNAME = "username";

  /** @param {string} what */
  const emitChanged = (what) =>
    Scratch.vm.runtime.startHats("runtimeoptions_whenChange", {
      WHAT: what,
    });

  /**
   * @template T
   * @param {T} obj
   * @returns {T}
   */
  const shallowCopy = (obj) => Object.assign({}, obj);

  let previousRuntimeOptions = shallowCopy(Scratch.vm.runtime.runtimeOptions);

  Scratch.vm.on("TURBO_MODE_OFF", () => emitChanged(TURBO_MODE));
  Scratch.vm.on("TURBO_MODE_ON", () => emitChanged(TURBO_MODE));
  Scratch.vm.on("INTERPOLATION_CHANGED", () => emitChanged(INTERPOLATION));
  Scratch.vm.on("RUNTIME_OPTIONS_CHANGED", (newOptions) => {
    if (newOptions.fencing !== previousRuntimeOptions.fencing) {
      emitChanged(REMOVE_FENCING);
    }
    if (newOptions.miscLimits !== previousRuntimeOptions.miscLimits) {
      emitChanged(REMOVE_MISC_LIMITS);
    }
    if (newOptions.maxClones !== previousRuntimeOptions.maxClones) {
      emitChanged(CLONE_LIMIT);
    }
    previousRuntimeOptions = shallowCopy(newOptions);
  });
  Scratch.vm.renderer.on("UseHighQualityRenderChanged", () =>
    emitChanged(HIGH_QUALITY_PEN)
  );
  Scratch.vm.on("FRAMERATE_CHANGED", () => emitChanged(FRAMERATE));
  Scratch.vm.on("STAGE_SIZE_CHANGED", () => emitChanged(STAGE_SIZE));

  const originalPostData = Scratch.vm.runtime.ioDevices.userData.postData;
  Scratch.vm.runtime.ioDevices.userData.postData = function (data) {
    const newUsername = data.username !== this._username;
    originalPostData.call(this, data);
    if (newUsername) {
      emitChanged(USERNAME);
    }
  };

  class RuntimeOptions {
    getInfo() {
      return {
        id: "runtimeoptions",
        name: Scratch.translate("Runtime Options"),
        color1: "#8c9abf",
        color2: "#7d8aab",
        color3: "#6f7b99",
        blocks: [
          {
            opcode: "getEnabled",
            text: Scratch.translate("[thing] enabled?"),
            blockType: Scratch.BlockType.BOOLEAN,
            arguments: {
              thing: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: TURBO_MODE,
                menu: "thing",
              },
            },
          },
          {
            opcode: "setEnabled",
            text: Scratch.translate("set [thing] to [enabled]"),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              thing: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: TURBO_MODE,
                menu: "thing",
              },
              enabled: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "true",
                menu: "enabled",
              },
            },
          },

          "---",

          {
            opcode: "getFramerate",
            text: Scratch.translate("framerate limit"),
            blockType: Scratch.BlockType.REPORTER,
          },
          {
            opcode: "setFramerate",
            text: Scratch.translate("set framerate limit to [fps]"),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              fps: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "30",
              },
            },
          },

          "---",

          {
            opcode: "getCloneLimit",
            text: Scratch.translate("clone limit"),
            blockType: Scratch.BlockType.REPORTER,
          },
          {
            opcode: "setCloneLimit",
            text: Scratch.translate("set clone limit to [limit]"),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              limit: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "300",
                menu: "clones",
              },
            },
          },

          "---",

          {
            opcode: "getDimension",
            text: Scratch.translate({
              default: "stage [dimension]",
              description: "[dimension] is a dropdown of width and height",
            }),
            blockType: Scratch.BlockType.REPORTER,
            arguments: {
              dimension: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "width",
                menu: "dimension",
              },
            },
          },
          {
            opcode: "setDimensions",
            text: Scratch.translate(
              "set stage size width: [width] height: [height]"
            ),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              width: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "480",
              },
              height: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: "360",
              },
            },
          },

          "---",

          {
            opcode: "setUsername",
            text: Scratch.translate("set username to [username]"),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              username: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "",
              },
            },
          },
          {
            opcode: "greenFlag",
            text: Scratch.translate("run green flag [flag]"),
            blockType: Scratch.BlockType.COMMAND,
            arguments: {
              flag: {
                type: Scratch.ArgumentType.IMAGE,
                dataURI: greenFlagURI,
              },
            },
          },

          "---",

          {
            opcode: "whenChange",
            blockType: Scratch.BlockType.EVENT,
            text: Scratch.translate("when [WHAT] changed"),
            isEdgeActivated: false,
            arguments: {
              WHAT: { type: Scratch.ArgumentType.STRING, menu: "changeable" },
            },
          },
        ],
        menus: {
          thing: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("turbo mode"),
                value: TURBO_MODE,
              },
              {
                text: Scratch.translate("interpolation"),
                value: INTERPOLATION,
              },
              {
                text: Scratch.translate("remove fencing"),
                value: REMOVE_FENCING,
              },
              {
                text: Scratch.translate("remove misc limits"),
                value: REMOVE_MISC_LIMITS,
              },
              {
                text: Scratch.translate("high quality pen"),
                value: HIGH_QUALITY_PEN,
              },
            ],
          },

          changeable: {
            acceptReporters: false,
            items: [
              {
                text: Scratch.translate("turbo mode"),
                value: TURBO_MODE,
              },
              {
                text: Scratch.translate("interpolation"),
                value: INTERPOLATION,
              },
              {
                text: Scratch.translate("remove fencing"),
                value: REMOVE_FENCING,
              },
              {
                text: Scratch.translate("remove misc limits"),
                value: REMOVE_MISC_LIMITS,
              },
              {
                text: Scratch.translate("high quality pen"),
                value: HIGH_QUALITY_PEN,
              },
              {
                text: Scratch.translate("framerate"),
                value: FRAMERATE,
              },
              {
                text: Scratch.translate("clone limit"),
                value: CLONE_LIMIT,
              },
              {
                text: Scratch.translate("stage size"),
                value: STAGE_SIZE,
              },
              {
                text: Scratch.translate("username"),
                value: USERNAME,
              },
            ],
          },

          enabled: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("enabled"),
                value: "true",
              },
              {
                text: Scratch.translate("disabled"),
                value: "false",
              },
            ],
          },

          clones: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("default ({n})", {
                  n: "300",
                }),
                value: "300",
              },
              {
                text: Scratch.translate("Infinity"),
                value: "Infinity",
              },
            ],
          },

          dimension: {
            acceptReporters: true,
            items: [
              {
                text: Scratch.translate("width"),
                value: "width",
              },
              {
                text: Scratch.translate("height"),
                value: "height",
              },
            ],
          },
        },
      };
    }

    getEnabled({ thing }) {
      if (thing === TURBO_MODE) {
        return Scratch.vm.runtime.turboMode;
      } else if (thing === INTERPOLATION) {
        return Scratch.vm.runtime.interpolationEnabled;
      } else if (thing === REMOVE_FENCING) {
        return !Scratch.vm.runtime.runtimeOptions.fencing;
      } else if (thing === REMOVE_MISC_LIMITS) {
        return !Scratch.vm.runtime.runtimeOptions.miscLimits;
      } else if (thing === HIGH_QUALITY_PEN) {
        return Scratch.renderer.useHighQualityRender;
      }
      return false;
    }

    setEnabled({ thing, enabled }) {
      enabled = Scratch.Cast.toBoolean(enabled);

      if (thing === TURBO_MODE) {
        Scratch.vm.setTurboMode(enabled);
      } else if (thing === INTERPOLATION) {
        Scratch.vm.setInterpolation(enabled);
      } else if (thing === REMOVE_FENCING) {
        Scratch.vm.setRuntimeOptions({
          fencing: !enabled,
        });
      } else if (thing === REMOVE_MISC_LIMITS) {
        Scratch.vm.setRuntimeOptions({
          miscLimits: !enabled,
        });
      } else if (thing === HIGH_QUALITY_PEN) {
        Scratch.renderer.setUseHighQualityRender(enabled);
      }
    }

    getFramerate() {
      return Scratch.vm.runtime.frameLoop.framerate;
    }

    setFramerate({ fps }) {
      fps = Scratch.Cast.toNumber(fps);
      Scratch.vm.setFramerate(fps);
    }

    getCloneLimit() {
      return Scratch.vm.runtime.runtimeOptions.maxClones;
    }
    setCloneLimit({ limit }) {
      limit = Scratch.Cast.toNumber(limit);
      Scratch.vm.setRuntimeOptions({
        maxClones: limit,
      });
    }

    getDimension({ dimension }) {
      if (dimension === "width") {
        return Scratch.vm.runtime.stageWidth;
      } else if (dimension === "height") {
        return Scratch.vm.runtime.stageHeight;
      }
      return 0;
    }

    setDimensions({ width, height }) {
      width = Scratch.Cast.toNumber(width);
      height = Scratch.Cast.toNumber(height);
      Scratch.vm.setStageSize(width, height);
    }

    setUsername({ username }) {
      Scratch.vm.postIOData("userData", {
        username: Scratch.Cast.toString(username),
      });
    }

    greenFlag() {
      Scratch.vm.runtime.greenFlag();
    }
  }

  Scratch.extensions.register(new RuntimeOptions());
})(Scratch);
